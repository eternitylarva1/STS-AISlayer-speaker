# 曼波语音解说功能集成说明

## 功能概述

已成功将曼波配音API集成到杀戮尖塔AI解说Mod中，实现了解说文本的自动语音播放功能。

## 新增功能

### 1. VoiceGenerator类
- **位置**: `src/main/java/aislayer/utils/VoiceGenerator.java`
- **功能**: 
  - 调用曼波API生成语音
  - 音频文件缓存管理
  - 异步音频播放
  - 音量控制
  - 语音开关控制

### 2. 语音配置选项
在`ConfigPanel.java`中新增了以下配置项：
- `voiceEnabled`: 是否启用语音解说（默认：true）
- `voiceVolume`: 语音音量控制（0.0-1.0，默认：0.8）
- `autoClearVoiceCache`: 是否自动清理语音缓存（默认：false）

### 3. CommentaryUtils增强
- 在`showCommentary()`方法中集成了语音生成调用
- 新增语音控制方法：
  - `setVoiceEnabled(boolean)`: 设置语音开关
  - `setVoiceVolume(float)`: 设置音量
  - `clearVoiceCache()`: 清理语音缓存
  - `stopVoicePlayback()`: 停止当前播放
  - `isVoicePlaying()`: 检查播放状态

## 使用方法

### 自动语音解说
1. 启用AI解说功能
2. 确保语音开关已开启（默认开启）
3. 游戏中的解说文本会自动生成对应的语音并播放

### 手动控制语音
```java
// 生成并播放语音
VoiceGenerator.generateAndPlayVoice("要播放的文本");

// 设置音量
CommentaryUtils.setVoiceVolume(0.5f);

// 禁用语音
CommentaryUtils.setVoiceEnabled(false);

// 清理缓存
CommentaryUtils.clearVoiceCache();
```

## 技术特性

### API集成
- **API地址**: `https://api.milorapart.top/apis/mbAIsc`
- **请求格式**: GET请求
- **参数**: 
  - `text`: 要转换的文本（必需）
  - `format`: 音频格式，支持mp3/wav（可选，默认mp3）
- **响应格式**: JSON
```json
{
  "code": 200,
  "msg": "生成完成!",
  "url": "https://api.milorapart.top/voice/xxx.mp3",
  "api_source": "官方API网:https://api.milorapart.top/"
}
```

### 缓存机制
- 语音文件自动缓存到`voice_cache`目录
- 避免重复生成相同文本的语音
- 支持缓存统计和清理

### 异步处理
- 语音生成和播放在独立线程中执行
- 不阻塞游戏主线程
- 支持播放状态监控

### 音频播放
- 使用Java Sound API播放MP3文件
- 支持音量调节
- 自动处理播放完成事件

## 配置说明

### 在游戏中配置
通过Mod配置面板可以调整：
- 语音开关
- 音量大小
- 缓存清理策略

### 代码配置
```java
// 启用/禁用语音
VoiceGenerator.voiceEnabled = true/false;

// 设置音量（0.0-1.0）
VoiceGenerator.setVolume(0.8f);

// 清理缓存
VoiceGenerator.clearCache();
```

## 测试功能

使用`VoiceTest`类进行功能测试：
```java
// 运行所有测试
VoiceTest.runAllTests();

// 单独测试
VoiceTest.testVoiceGeneration();  // 测试语音生成
VoiceTest.testVoiceSettings();   // 测试配置功能
VoiceTest.testVoiceCache();      // 测试缓存功能
```

## 注意事项

1. **网络依赖**: 语音生成需要网络连接
2. **API限制**: 请遵守API使用条款和限制
3. **性能考虑**: 首次生成语音需要下载，会有一定延迟
4. **存储空间**: 语音缓存会占用磁盘空间
5. **兼容性**: 需要Java Sound API支持

## 故障排除

### 常见问题
1. **没有声音**: 检查语音开关和音量设置
2. **生成失败**: 检查网络连接和API可用性
3. **播放异常**: 检查音频系统和文件权限

### 调试信息
查看日志获取详细错误信息和调试信息。

## 未来改进

1. 支持更多语音引擎
2. 添加语音效果处理
3. 优化缓存策略
4. 支持语音队列管理
5. 添加语音历史记录

---

现在你的杀戮尖塔AI解说Mod已经具备了完整的语音功能，可以为玩家提供更加沉浸式的游戏体验！