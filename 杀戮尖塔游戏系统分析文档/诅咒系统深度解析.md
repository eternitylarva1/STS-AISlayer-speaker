# 诅咒系统深度解析

## 概述

杀戮尖塔的诅咒系统是游戏中的负面卡牌机制，通过添加各种具有负面效果的卡牌来增加游戏难度和策略深度。诅咒卡牌通常无法主动打出，但会在特定条件下触发负面效果，为玩家带来额外的挑战和风险管理的需求。

## 诅咒卡牌基础特性

### 核心属性

所有诅咒卡牌都继承自 `AbstractCard` 并具有以下共同特征：

```java
// 基本属性设置
super("CardID", cardStrings.NAME, "curse/card_image_path", -2, 
      cardStrings.DESCRIPTION, 
      AbstractCard.CardType.CURSE,    // 卡牌类型：诅咒
      AbstractCard.CardColor.CURSE,   // 卡牌颜色：诅咒色
      AbstractCard.CardRarity.CURSE,  // 稀有度：诅咒
      AbstractCard.CardTarget.NONE);  // 目标：无

// 诅咒卡牌的共同特征
public void use(AbstractPlayer p, AbstractMonster m) {
    // 大多数诅咒卡牌没有主动使用效果
}

public void upgrade() {
    // 诅咒卡牌无法升级
}
```

### 特殊属性

```java
// 虚无属性（某些诅咒卡牌）
this.isEthereal = true; // 回合结束时被弃置

// 无法打出
public boolean canPlay(AbstractCard card) {
    // 某些诅咒卡牌有特殊的打出条件
    return false;
}
```

## 诅咒卡牌分类

### 1. 基础诅咒卡牌

#### Pain（痛苦）

```java
public class Pain extends AbstractCard {
    private static final CardStrings cardStrings = CardCrawlGame.languagePack.getCardStrings("Pain");
    public static final String ID = "Pain";
    
    public Pain() {
        super("Pain", cardStrings.NAME, "curse/pain", -2, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.CURSE, AbstractCard.CardTarget.NONE);
    }
    
    // 触发条件：当其他卡牌被打出时
    public void triggerOnOtherCardPlayed(AbstractCard c) {
        addToTop(new LoseHPAction(AbstractDungeon.player, AbstractDungeon.player, 1));
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {}
    public void upgrade() {}
    public AbstractCard makeCopy() { return new Pain(); }
}
```

**效果分析**：
- **触发时机**：每当玩家打出任何其他卡牌时
- **负面效果**：失去1点生命值
- **策略影响**：限制玩家在一回合内打出过多卡牌
- **风险等级**：中等，累积伤害可观

#### Normality（常态）

```java
public class Normality extends AbstractCard {
    public static final String ID = "Normality";
    private static final CardStrings cardStrings = CardCrawlGame.languagePack.getCardStrings("Normality");
    private static final int PLAY_LIMIT = 3;
    
    public Normality() {
        super("Normality", cardStrings.NAME, "curse/normality", -2, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.CURSE, AbstractCard.CardTarget.NONE);
    }
    
    // 打出限制检查
    public boolean canPlay(AbstractCard card) {
        if (AbstractDungeon.actionManager.cardsPlayedThisTurn.size() >= 3) {
            card.cantUseMessage = cardStrings.EXTENDED_DESCRIPTION[0];
            return false;
        }
        return true;
    }
    
    // 动态描述更新
    public void applyPowers() {
        super.applyPowers();
        
        int cardsPlayed = AbstractDungeon.actionManager.cardsPlayedThisTurn.size();
        if (cardsPlayed == 0) {
            this.rawDescription = cardStrings.EXTENDED_DESCRIPTION[1] + '\003' + 
                                  cardStrings.EXTENDED_DESCRIPTION[2];
        } else if (cardsPlayed == 1) {
            this.rawDescription = cardStrings.EXTENDED_DESCRIPTION[1] + '\003' + 
                                  cardStrings.EXTENDED_DESCRIPTION[3] + cardsPlayed + 
                                  cardStrings.EXTENDED_DESCRIPTION[4];
        } else {
            this.rawDescription = cardStrings.EXTENDED_DESCRIPTION[1] + '\003' + 
                                  cardStrings.EXTENDED_DESCRIPTION[3] + cardsPlayed + 
                                  cardStrings.EXTENDED_DESCRIPTION[5];
        }
        initializeDescription();
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {}
    public void upgrade() {}
    public AbstractCard makeCopy() { return new Normality(); }
}
```

**效果分析**：
- **限制机制**：每回合最多只能打出3张卡牌
- **动态描述**：实时显示已打出的卡牌数量
- **策略影响**：严重影响连招和组合技的执行
- **风险等级**：高，严重限制战术选择

### 2. 特殊诅咒卡牌

#### AscendersBane（攀登者之祸）

```java
public class AscendersBane extends AbstractCard {
    public static final String ID = "AscendersBane";
    private static final CardStrings cardStrings = CardCrawlGame.languagePack.getCardStrings("AscendersBane");
    
    public AscendersBane() {
        super("AscendersBane", cardStrings.NAME, "curse/ascenders_bane", -2, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.SPECIAL, AbstractCard.CardTarget.NONE);
        
        this.isEthereal = true; // 虚无属性
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {}
    public void upgrade() {}
    public AbstractCard makeCopy() { return new AscendersBane(); }
}
```

**效果分析**：
- **特殊属性**：虚无卡牌，回合结束时自动弃置
- **获取条件**： ascendension模式（高难度模式）开始时自动获得
- **设计目的**：增加高难度模式的挑战性
- **风险等级**：低，主要占用卡组空间

#### Pride（骄傲）

```java
public class Pride extends AbstractCard {
    private static final CardStrings cardStrings = CardCrawlGame.languagePack.getCardStrings("Pride");
    public static final String ID = "Pride";
    
    public Pride() {
        super("Pride", cardStrings.NAME, "curse/pride", 1, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.SPECIAL, AbstractCard.CardTarget.SELF);
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {
        // 可以被打出，效果是在抽牌堆添加更多诅咒
        addToBot(new MakeTempCardInDrawPileAction(new Pride(), 1, true, true));
    }
    
    public void upgrade() {}
    public AbstractCard makeCopy() { return new Pride(); }
}
```

**效果分析**：
- **独特机制**：可以主动打出，费用为1
- **自我复制**：打出后在抽牌堆添加新的骄傲
- **稀有度**：特殊，通常通过特定事件获得
- **风险等级**：极高，可能导致诅咒无限增殖

### 3. 伤害型诅咒卡牌

#### Regret（悔恨）

```java
public class Regret extends AbstractCard {
    private static final CardStrings cardStrings = CardCrawlGame.languagePack.getCardStrings("Regret");
    public static final String ID = "Regret";
    
    public Regret() {
        super("Regret", cardStrings.NAME, "curse/regret", -2, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.CURSE, AbstractCard.CardTarget.NONE);
    }
    
    public void triggerWhenDrawn() {
        // 抽到时立即触发效果
        addToTop(new LoseHPAction(AbstractDungeon.player, AbstractDungeon.player, 
                AbstractDungeon.player.masterDeck.size()));
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {}
    public void upgrade() {}
    public AbstractCard makeCopy() { return new Regret(); }
}
```

**效果分析**：
- **触发时机**：被抽到手牌时立即触发
- **伤害计算**：基于当前卡组大小
- **策略影响**：鼓励玩家保持小卡组
- **风险等级**：极高，后期可能造成大量伤害

#### Decay（腐朽）

```java
public class Decay extends AbstractCard {
    public static final String ID = "Decay";
    private static final CardStrings cardStrings = CardCrawlGame.languagePack.getCardStrings("Decay");
    
    public Decay() {
        super("Decay", cardStrings.NAME, "curse/decay", -2, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.CURSE, AbstractCard.CardTarget.NONE);
    }
    
    public void triggerOnEndOfTurnForPlayingCard() {
        // 回合结束时触发
        addToTop(new DamageAction(AbstractDungeon.player, 
                new DamageInfo(AbstractDungeon.player, 5, DamageInfo.DamageType.THORNS)));
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {}
    public void upgrade() {}
    public AbstractCard makeCopy() { return new Decay(); }
}
```

**效果分析**：
- **触发时机**：手牌中时回合结束触发
- **固定伤害**：每回合造成5点伤害
- **持续威胁**：只要在手牌中就会持续造成伤害
- **风险等级**：高，需要尽快弃置

### 4. 控制型诅咒卡牌

#### Doubt（怀疑）

```java
public class Doubt extends AbstractCard {
    private static final CardStrings cardStrings = CardCrawlGame.languagePack.getCardStrings("Doubt");
    public static final String ID = "Doubt";
    
    public Doubt() {
        super("Doubt", cardStrings.NAME, "curse/doubt", -2, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.CURSE, AbstractCard.CardTarget.NONE);
    }
    
    public void triggerOnEndOfTurnForPlayingCard() {
        // 回合结束时添加虚弱能力
        addToTop(new ApplyPowerAction(AbstractDungeon.player, AbstractDungeon.player, 
                new WeakPower(AbstractDungeon.player, 1, true), 1));
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {}
    public void upgrade() {}
    public AbstractCard makeCopy() { return new Doubt(); }
}
```

**效果分析**：
- **控制效果**：每回合添加1层虚弱
- **累积威胁**：虚弱效果会累积，严重影响输出
- **策略影响**：需要尽快弃置或净化
- **风险等级**：高，严重影响战斗能力

#### Shame（羞耻）

```java
public class Shame extends AbstractCard {
    private static final CardStrings cardStrings = CardCrawlGame.languagePack.getCardStrings("Shame");
    public static final String ID = "Shame";
    
    public Shame() {
        super("Shame", cardStrings.NAME, "curse/shame", -2, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.CURSE, AbstractCard.CardTarget.NONE);
    }
    
    public void triggerOnEndOfTurnForPlayingCard() {
        // 回合结束时添加易伤能力
        addToTop(new ApplyPowerAction(AbstractDungeon.player, AbstractDungeon.player, 
                new VulnerablePower(AbstractDungeon.player, 1, true), 1));
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {}
    public void upgrade() {}
    public AbstractCard makeCopy() { return new Shame(); }
}
```

**效果分析**：
- **控制效果**：每回合添加1层易伤
- **防御削弱**：增加受到的伤害
- **双重威胁**：与虚弱配合效果更差
- **风险等级**：高，严重影响生存能力

## 诅咒卡牌获取机制

### 1. 事件奖励

许多事件会给予玩家诅咒卡牌作为选择：

```java
// 事件中添加诅咒的典型代码
public void onEnterRoom() {
    if (AbstractDungeon.getCurrRoom() instanceof EventRoom) {
        AbstractDungeon.eventList.add("CurseEvent");
    }
}

// 事件结果处理
public void buttonEffect(int buttonPressed) {
    switch (buttonPressed) {
        case 0:
            AbstractDungeon.effectList.add(new ShowCardAndObtainEffect(new Pain()));
            break;
        case 1:
            // 其他选择
            break;
    }
}
```

### 2. 怪物奖励

某些怪物会在战斗胜利后给予诅咒：

```java
// 怪物死亡时的奖励处理
public void onDeath() {
    if (!AbstractDungeon.getMonsters().areMonstersBasicallyDead()) return;
    
    // 添加诅咒到卡组
    AbstractDungeon.effectList.add(new ShowCardAndAddToDiscardEffect(new Regret()));
}
```

### 3. 遗物效果

某些遗物会主动添加诅咒：

```java
// 诅咒遗物的典型实现
public void atTurnStart() {
    if (AbstractDungeon.player.masterDeck.size() < 10) {
        AbstractDungeon.effectList.add(
            new ShowCardAndAddToDeckEffect(new Normality()));
    }
}
```

### 4. 卡牌效果

一些卡牌的效果会添加诅咒：

```java
// 添加诅咒的卡牌效果
public void use(AbstractPlayer p, AbstractMonster m) {
    addToBot(new MakeTempCardInDrawPileAction(new Doubt(), 1, true, true));
}
```

## 诅咒卡牌管理策略

### 1. 净化机制

```java
// 净化药水的效果
public void use(AbstractCreature target) {
    // 从手牌中移除诅咒
    for (AbstractCard c : AbstractDungeon.player.hand.group) {
        if (c.type == AbstractCard.CardType.CURSE) {
            AbstractDungeon.player.hand.moveToExhaustPile(c);
            break;
        }
    }
}
```

### 2. 遗物对抗

```java
// 蓝蜡烛遗物效果
public void onExhaust(AbstractCard c) {
    if (c.type == AbstractCard.CardType.CURSE) {
        AbstractDungeon.player.gainGold(3);
    }
}
```

### 3. 卡牌移除

```java
// 移除卡牌服务的实现
public void removeCardFromDeck(AbstractCard card) {
    if (AbstractDungeon.player.masterDeck.contains(card)) {
        AbstractDungeon.player.masterDeck.removeCard(card);
        AbstractDungeon.effectList.add(new ShowCardBrieflyEffect(card));
    }
}
```

## 诅咒系统设计理念

### 1. 风险与回报

诅咒系统通过以下方式平衡风险与回报：

- **事件选择**：玩家可以选择接受诅咒获得其他奖励
- **强度平衡**：强大的效果往往伴随着诅咒风险
- **策略深度**：需要权衡短期收益与长期负担

### 2. 游戏节奏控制

诅咒卡牌影响游戏节奏：

- **手牌管理**：增加手牌管理的复杂性
- **卡组构建**：影响卡组大小和一致性
- **资源分配**：需要分配资源处理诅咒

### 3. 主题一致性

诅咒系统与游戏主题保持一致：

- **黑暗奇幻**：诅咒符合游戏的黑暗奇幻主题
- **心理压力**：诅咒增加玩家的心理压力感
- **挑战性**：体现游戏的挑战精神

## 性能优化

### 1. 触发条件优化

```java
// 高效的触发检查
public void triggerOnOtherCardPlayed(AbstractCard c) {
    // 避免不必要的计算
    if (c == this || c.type == AbstractCard.CardType.CURSE) {
        return;
    }
    
    // 执行效果
    addToTop(new LoseHPAction(AbstractDungeon.player, AbstractDungeon.player, 1));
}
```

### 2. 描述更新优化

```java
// 缓存描述文本
private String cachedDescription = null;
private int lastCardsPlayed = -1;

public void applyPowers() {
    super.applyPowers();
    
    int currentCardsPlayed = AbstractDungeon.actionManager.cardsPlayedThisTurn.size();
    if (currentCardsPlayed != lastCardsPlayed) {
        updateDescription(currentCardsPlayed);
        lastCardsPlayed = currentCardsPlayed;
    }
}
```

### 3. 内存管理

```java
// 避免重复创建对象
private static final LoseHPAction PAIN_ACTION = 
    new LoseHPAction(null, null, 1);

public void triggerOnOtherCardPlayed(AbstractCard c) {
    LoseHPAction action = PAIN_ACTION.makeCopy();
    action.source = AbstractDungeon.player;
    action.target = AbstractDungeon.player;
    addToTop(action);
}
```

## 扩展性设计

### 1. 新诅咒添加

添加新诅咒卡牌的模板：

```java
public class NewCurse extends AbstractCard {
    public static final String ID = "NewCurse";
    
    public NewCurse() {
        super(ID, cardStrings.NAME, "curse/new_curse", -2, cardStrings.DESCRIPTION, 
              AbstractCard.CardType.CURSE, AbstractCard.CardColor.CURSE, 
              AbstractCard.CardRarity.CURSE, AbstractCard.CardTarget.NONE);
    }
    
    // 实现特定的触发条件
    public void triggerOnSpecificCondition() {
        // 诅咒效果
    }
    
    public void use(AbstractPlayer p, AbstractMonster m) {}
    public void upgrade() {}
    public AbstractCard makeCopy() { return new NewCurse(); }
}
```

### 2. 模组支持

```java
// 诅咒注册系统
public class CurseRegistry {
    private static final Map<String, Class<? extends AbstractCard>> curseMap = new HashMap<>();
    
    public static void registerCurse(String id, Class<? extends AbstractCard> curseClass) {
        curseMap.put(id, curseClass);
    }
    
    public static AbstractCard createCurse(String id) {
        Class<? extends AbstractCard> curseClass = curseMap.get(id);
        if (curseClass != null) {
            try {
                return curseClass.newInstance();
            } catch (Exception e) {
                logger.error("Failed to create curse: " + id, e);
            }
        }
        return null;
    }
}
```

## 总结

杀戮尖塔的诅咒系统是一个精心设计的负面机制系统，具有以下特点：

1. **多样性** - 包含多种不同类型的诅咒效果
2. **平衡性** - 通过风险与回报的平衡增加策略深度
3. **主题性** - 与游戏的黑暗奇幻主题高度契合
4. **交互性** - 与其他游戏系统深度交互
5. **扩展性** - 易于添加新的诅咒卡牌
6. **性能优化** - 高效的触发机制和内存管理

该系统通过诅咒卡牌为玩家提供了额外的挑战层次，要求玩家在卡组构建、资源管理和战术选择上进行更深入的思考。诅咒不仅是负面效果，更是游戏设计的重要组成部分，为杀戮尖塔增添了独特的策略深度和重玩价值。